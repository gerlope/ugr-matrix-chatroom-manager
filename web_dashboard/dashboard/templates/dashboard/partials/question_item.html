{% comment %} Single question item used inside questions_panel {% endcomment %}
<li x-data="{ open: false, showManualOnly: false }" x-init="open = __lsGet('q_open_{{ q.id }}') === 'true'; showManualOnly = __lsGet('q_manual_only_{{ q.id }}') === 'true'" data-question-id="{{ q.id }}" class="py-2 hover:bg-gray-50 rounded transition cursor-pointer" @click="open = !open; __lsSet('q_open_{{ q.id }}', open ? 'true' : 'false')" tabindex="0" @keydown.enter.prevent="open = !open; __lsSet('q_open_{{ q.id }}', open ? 'true' : 'false')" @keydown.space.prevent="open = !open; __lsSet('q_open_{{ q.id }}', open ? 'true' : 'false')">
  <div class="w-full text-left">
    <div class="w-full flex justify-between items-start text-left px-2 py-2 gap-4">
      <div class="flex-1">
        <div class="font-semibold">{{ q.title|default:"(sin título)" }}</div>
        <div class="text-gray-700 text-sm mt-1">{{ q.body }}</div>
        <div class="text-xs text-gray-500 mt-1">Tipo: {{ q.qtype }} · Creada: {{ q.created_at|date:"Y-m-d H:i" }}</div>
        
        {% if selected_room.teacher_id == teacher.id and q.qtype != 'essay' and q.qtype != 'poll' %}
          <div class="mt-2">
            <button type="button" onclick="event.stopPropagation();" class="px-2 py-1 text-sm bg-indigo-500 text-white rounded toggle-reveal-btn" data-qid="{{ q.id }}">Mostrar respuestas correctas</button>
          </div>
        {% endif %}

        {% if opts %}
          <div class="mt-3">
            {% if q.qtype == 'short_answer' or q.qtype == 'numeric' %}
              {% for o in opts %}{% if o.option_key == 'ANSWER' %}
                <div class="expected-answer text-sm text-gray-700" style="display:none; white-space:pre;">    Respuesta esperada: {{ o.text }}</div>
              {% endif %}{% endfor %}
            {% else %}
              <ul class="list-disc ml-5 text-sm text-gray-700">
                {% for o in opts %}
                  <li class="space-x-2">
                    <span class="flex-1">{{ o.option_key }}. {{ o.text }}</span>
                    {% if o.is_correct %}
                      <span class="correct-indicator inline-block text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded" style="display:none">✅ Correcta</span>
                    {% endif %}
                  </li>
                {% endfor %}
              </ul>
            {% endif %}
          </div>
        {% endif %}
      </div>
      
      <div class="flex-shrink-0">
        <div class="text-right text-sm text-gray-600">
          {% if q.manual_active %}
            <span class="inline-block bg-yellow-100 text-yellow-800 px-2 py-1 rounded">Manual</span>
          {% endif %}
          {% if active_now %}
            <div class="inline-block bg-green-100 text-green-800 px-2 py-1 rounded">Activo</div>
          {% else %}
            <div class="inline-block bg-red-100 text-red-800 px-2 py-1 rounded">Inactivo</div>
          {% endif %}
          {% if q.close_on_first_correct %}
            <div class="inline-block bg-purple-100 text-purple-800 px-2 py-1 rounded mt-1">Cierra tras 1ª correcta</div>
          {% endif %}
          {% if q.close_triggered %}
            <div class="inline-block bg-gray-200 text-gray-800 px-2 py-1 rounded mt-1">Cerrada (1ª correcta recibida)</div>
          {% endif %}
          {% if q.qtype == 'multiple_choice' %}
            {% if q.allow_multiple_answers %}
              <div class="inline-block bg-indigo-100 text-indigo-800 px-2 py-1 rounded mt-1">Múltiple selección</div>
            {% endif %}
          {% endif %}
          {% if q.allow_multiple_submissions %}
            <div class="inline-block bg-blue-100 text-blue-800 px-2 py-1 rounded mt-1">Varios envíos</div>
          {% endif %}
        </div>
        
        {# Pie chart and schedule dates side by side #}
        <div class="flex items-start gap-3 mt-2">
          {# Pie chart #}
          {% with sd=item.score_distribution sd_manual=item.score_distribution_manual %}
          <div class="flex items-start gap-2">
            {% if sd.total > 0 %}
              <div x-show="!showManualOnly">
                <svg width="80" height="80" viewBox="0 0 42 42" class="transform -rotate-90">
                  <circle cx="21" cy="21" r="15.915" fill="transparent" stroke="#FCA5A5" stroke-width="4" 
                          stroke-dasharray="{{ sd.pct_0_49|floatformat:2 }} 100" stroke-dashoffset="0"></circle>
                  <circle cx="21" cy="21" r="15.915" fill="transparent" stroke="#FCD34D" stroke-width="4" 
                          stroke-dasharray="{{ sd.pct_50_74|floatformat:2 }} 100" stroke-dashoffset="{{ sd.offset_50_74|floatformat:2 }}"></circle>
                  <circle cx="21" cy="21" r="15.915" fill="transparent" stroke="#6EE7B7" stroke-width="4" 
                          stroke-dasharray="{{ sd.pct_75_99|floatformat:2 }} 100" stroke-dashoffset="{{ sd.offset_75_99|floatformat:2 }}"></circle>
                  <circle cx="21" cy="21" r="15.915" fill="transparent" stroke="#93C5FD" stroke-width="4" 
                          stroke-dasharray="{{ sd.pct_100|floatformat:2 }} 100" stroke-dashoffset="{{ sd.offset_100|floatformat:2 }}"></circle>
                  <circle cx="21" cy="21" r="15.915" fill="transparent" stroke="#D1D5DB" stroke-width="4" 
                          stroke-dasharray="{{ sd.pct_no_score|floatformat:2 }} 100" stroke-dashoffset="{{ sd.offset_no_score|floatformat:2 }}"></circle>
                </svg>
              </div>
              <div x-show="showManualOnly" x-cloak>
                <svg width="80" height="80" viewBox="0 0 42 42" class="transform -rotate-90">
                  <circle cx="21" cy="21" r="15.915" fill="transparent" stroke="#FCA5A5" stroke-width="4" 
                          stroke-dasharray="{{ sd_manual.pct_0_49|floatformat:2 }} 100" stroke-dashoffset="0"></circle>
                  <circle cx="21" cy="21" r="15.915" fill="transparent" stroke="#FCD34D" stroke-width="4" 
                          stroke-dasharray="{{ sd_manual.pct_50_74|floatformat:2 }} 100" stroke-dashoffset="{{ sd_manual.offset_50_74|floatformat:2 }}"></circle>
                  <circle cx="21" cy="21" r="15.915" fill="transparent" stroke="#6EE7B7" stroke-width="4" 
                          stroke-dasharray="{{ sd_manual.pct_75_99|floatformat:2 }} 100" stroke-dashoffset="{{ sd_manual.offset_75_99|floatformat:2 }}"></circle>
                  <circle cx="21" cy="21" r="15.915" fill="transparent" stroke="#93C5FD" stroke-width="4" 
                          stroke-dasharray="{{ sd_manual.pct_100|floatformat:2 }} 100" stroke-dashoffset="{{ sd_manual.offset_100|floatformat:2 }}"></circle>
                  <circle cx="21" cy="21" r="15.915" fill="transparent" stroke="#D1D5DB" stroke-width="4" 
                          stroke-dasharray="{{ sd_manual.pct_no_score|floatformat:2 }} 100" stroke-dashoffset="{{ sd_manual.offset_no_score|floatformat:2 }}"></circle>
                </svg>
              </div>
            {% else %}
              <div>
                <svg width="80" height="80" viewBox="0 0 42 42" class="transform -rotate-90">
                  <circle cx="21" cy="21" r="15.915" fill="transparent" stroke="#D1D5DB" stroke-width="4" 
                          stroke-dasharray="100 100" stroke-dashoffset="0"></circle>
                </svg>
              </div>
            {% endif %}
              <div class="flex flex-col gap-1">
                <div class="text-xs text-gray-600 leading-tight">
                  <div x-show="!showManualOnly">
                    <div class="flex items-center gap-1"><span class="inline-block w-2 h-2 bg-red-300 rounded-full"></span><span>0-49: {{ sd.bracket_0_49 }}</span></div>
                    <div class="flex items-center gap-1"><span class="inline-block w-2 h-2 bg-yellow-300 rounded-full"></span><span>50-74: {{ sd.bracket_50_74 }}</span></div>
                    <div class="flex items-center gap-1"><span class="inline-block w-2 h-2 bg-green-300 rounded-full"></span><span>75-99: {{ sd.bracket_75_99 }}</span></div>
                    <div class="flex items-center gap-1"><span class="inline-block w-2 h-2 bg-blue-300 rounded-full"></span><span>100: {{ sd.bracket_100 }}</span></div>
                    <div class="flex items-center gap-1"><span class="inline-block w-2 h-2 bg-gray-300 rounded-full"></span><span>Sin nota: {{ sd.no_score }}</span></div>
                    {% if sd.average is not None %}
                    <div class="mt-1 pt-1 border-t border-gray-300 font-semibold">Media: {{ sd.average }}</div>
                    {% endif %}
                  </div>
                  <div x-show="showManualOnly" x-cloak>
                    <div class="flex items-center gap-1"><span class="inline-block w-2 h-2 bg-red-300 rounded-full"></span><span>0-49: {{ sd_manual.bracket_0_49 }}</span></div>
                    <div class="flex items-center gap-1"><span class="inline-block w-2 h-2 bg-yellow-300 rounded-full"></span><span>50-74: {{ sd_manual.bracket_50_74 }}</span></div>
                    <div class="flex items-center gap-1"><span class="inline-block w-2 h-2 bg-green-300 rounded-full"></span><span>75-99: {{ sd_manual.bracket_75_99 }}</span></div>
                    <div class="flex items-center gap-1"><span class="inline-block w-2 h-2 bg-blue-300 rounded-full"></span><span>100: {{ sd_manual.bracket_100 }}</span></div>
                    <div class="flex items-center gap-1"><span class="inline-block w-2 h-2 bg-gray-300 rounded-full"></span><span>Sin nota: {{ sd_manual.no_score }}</span></div>
                    {% if sd_manual.average is not None %}
                    <div class="mt-1 pt-1 border-t border-gray-300 font-semibold">Media: {{ sd_manual.average }}</div>
                    {% endif %}
                  </div>
                </div>
                <button type="button" @click.stop="showManualOnly = !showManualOnly; __lsSet('q_manual_only_{{ q.id }}', showManualOnly ? 'true' : 'false')" 
                        class="px-2 py-0.5 text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 rounded transition">
                  <span x-show="!showManualOnly">Solo manuales</span>
                  <span x-show="showManualOnly" x-cloak>Todas</span>
                </button>
              </div>
            </div>
          {% endwith %}
          
          {# Submission count distribution (only for multiple submissions allowed) #}
          {% if q.allow_multiple_submissions and item.submission_distribution %}
            {% with sub_dist=item.submission_distribution %}
            {% if sub_dist.total > 0 %}
              <div class="flex items-start gap-2">
                <div>
                  <svg width="80" height="80" viewBox="0 0 42 42" class="transform -rotate-90">
                    <circle cx="21" cy="21" r="15.915" fill="transparent" stroke="#BFDBFE" stroke-width="4" 
                            stroke-dasharray="{{ sub_dist.pct_1|floatformat:2 }} 100" stroke-dashoffset="0"></circle>
                    <circle cx="21" cy="21" r="15.915" fill="transparent" stroke="#93C5FD" stroke-width="4" 
                            stroke-dasharray="{{ sub_dist.pct_2|floatformat:2 }} 100" stroke-dashoffset="{{ sub_dist.offset_2|floatformat:2 }}"></circle>
                    <circle cx="21" cy="21" r="15.915" fill="transparent" stroke="#60A5FA" stroke-width="4" 
                            stroke-dasharray="{{ sub_dist.pct_3|floatformat:2 }} 100" stroke-dashoffset="{{ sub_dist.offset_3|floatformat:2 }}"></circle>
                    <circle cx="21" cy="21" r="15.915" fill="transparent" stroke="#3B82F6" stroke-width="4" 
                            stroke-dasharray="{{ sub_dist.pct_4|floatformat:2 }} 100" stroke-dashoffset="{{ sub_dist.offset_4|floatformat:2 }}"></circle>
                    <circle cx="21" cy="21" r="15.915" fill="transparent" stroke="#1D4ED8" stroke-width="4" 
                            stroke-dasharray="{{ sub_dist.pct_5_plus|floatformat:2 }} 100" stroke-dashoffset="{{ sub_dist.offset_5_plus|floatformat:2 }}"></circle>
                  </svg>
                </div>
                <div class="flex flex-col gap-1">
                  <div class="text-xs text-gray-600 font-semibold">Envíos por alumno:</div>
                  <div class="text-xs text-gray-600 leading-tight">
                    <div class="flex items-center gap-1"><span class="inline-block w-2 h-2 bg-blue-200 rounded-full"></span><span>1 envío: {{ sub_dist.bracket_1 }}</span></div>
                    <div class="flex items-center gap-1"><span class="inline-block w-2 h-2 bg-blue-300 rounded-full"></span><span>2 envíos: {{ sub_dist.bracket_2 }}</span></div>
                    <div class="flex items-center gap-1"><span class="inline-block w-2 h-2 bg-blue-400 rounded-full"></span><span>3 envíos: {{ sub_dist.bracket_3 }}</span></div>
                    <div class="flex items-center gap-1"><span class="inline-block w-2 h-2 bg-blue-500 rounded-full"></span><span>4 envíos: {{ sub_dist.bracket_4 }}</span></div>
                    <div class="flex items-center gap-1"><span class="inline-block w-2 h-2 bg-blue-700 rounded-full"></span><span>5+ envíos: {{ sub_dist.bracket_5_plus }}</span></div>
                  </div>
                </div>
              </div>
            {% endif %}
            {% endwith %}
          {% endif %}
          
          {# Participation distribution (only for Moodle group-bound rooms) #}
          {% if item.participation_distribution %}
            {% with part_dist=item.participation_distribution %}
            {% if part_dist.total > 0 %}
              <div class="flex items-start gap-2">
                <div>
                  <svg width="80" height="80" viewBox="0 0 42 42" class="transform -rotate-90">
                    <circle cx="21" cy="21" r="15.915" fill="transparent" stroke="#6EE7B7" stroke-width="4" 
                            stroke-dasharray="{{ part_dist.pct_answered|floatformat:2 }} 100" stroke-dashoffset="0"></circle>
                    <circle cx="21" cy="21" r="15.915" fill="transparent" stroke="#D1D5DB" stroke-width="4" 
                            stroke-dasharray="{{ part_dist.pct_not_answered|floatformat:2 }} 100" stroke-dashoffset="{{ part_dist.offset_not_answered|floatformat:2 }}"></circle>
                  </svg>
                </div>
                <div class="flex flex-col gap-1">
                  <div class="text-xs text-gray-600 font-semibold">Participación del grupo:</div>
                  <div class="text-xs text-gray-600 leading-tight">
                    <div class="flex items-center gap-1"><span class="inline-block w-2 h-2 bg-green-300 rounded-full"></span><span>Respondieron: {{ part_dist.answered }}</span></div>
                    <div class="flex items-center gap-1"><span class="inline-block w-2 h-2 bg-gray-300 rounded-full"></span><span>No respondieron: {{ part_dist.not_answered }}</span></div>
                    <div class="mt-1 pt-1 border-t border-gray-300 font-semibold">Participación: {{ part_dist.pct_answered|floatformat:1 }}%</div>
                  </div>
                </div>
              </div>
            {% endif %}
            {% endwith %}
          {% endif %}
          
          {# Schedule dates #}
          <div class="text-sm text-gray-600">
            {% if q.start_at %}
              <div>Desde: {{ q.start_at|date:"Y-m-d H:i" }}</div>
            {% endif %}
            {% if q.end_at %}
              <div>Hasta: {{ q.end_at|date:"Y-m-d H:i" }}</div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  {% if selected_room.teacher_id == teacher.id %}
    <div class="mt-3 flex justify-between items-center">
      <form method="post" action="{% url 'dashboard:toggle_question_active' q.id %}" onclick="event.stopPropagation();">
        {% csrf_token %}
        {% if q.close_on_first_correct and q.close_triggered %}
          <div class="px-3 py-1 bg-gray-200 text-gray-700 rounded text-sm">Cerrada tras 1ª correcta — no se puede reabrir</div>
        {% else %}
          {% if not q.start_at and not q.end_at %}
            {% if q.manual_active %}
              <button type="submit" class="px-3 py-1 bg-red-600 text-white rounded">Desactivar</button>
            {% else %}
              <button type="submit" class="px-3 py-1 bg-green-600 text-white rounded">Activar</button>
            {% endif %}
          {% else %}
            {% if active_now %}
              {% if not within_window and q.end_at %}
                <button type="submit" class="px-3 py-1 bg-red-600 text-white rounded">Desactivar (fuera de horario)</button>
              {% else %}
                <button type="submit" class="px-3 py-1 bg-red-600 text-white rounded">Finalizar ahora</button>
              {% endif %}
            {% else %}
              {% if before_start %}
                <button type="submit" class="px-3 py-1 bg-green-600 text-white rounded">Iniciar ahora</button>
              {% elif after_end %}
                <button type="submit" class="px-3 py-1 bg-green-600 text-white rounded">Activar (fuera de horario)</button>
              {% else %}
                <button type="submit" class="px-3 py-1 bg-green-600 text-white rounded">Activar</button>
              {% endif %}
            {% endif %}
          {% endif %}
        {% endif %}
      </form>

      <button 
        type="button" 
        @click.stop="$store.modal.deleteQuestionId = {{ q.id }}; $store.modal.deleteQuestionTitle = '{{ q.title|escapejs }}'; $store.modal.deleteQuestionModal = true"
        class="px-3 py-1 bg-gray-600 text-white rounded"
      >
        Eliminar
      </button>
    </div>
  {% endif %}

  {% include 'dashboard/partials/question_responses.html' %}
</li>
