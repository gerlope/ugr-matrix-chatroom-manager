{% comment %} Students panel: list of students and their reactions {% endcomment %}
<div class="bg-white shadow rounded-lg p-4">
  <div class="flex justify-between items-center mb-4">
    <h3 class="text-lg font-semibold">Estudiantes</h3>
    <button 
      @click="downloadStudentsJSON()" 
      class="px-3 py-1.5 bg-blue-500 hover:bg-blue-600 text-white text-sm rounded transition flex items-center gap-1"
      title="Descargar datos de estudiantes como JSON"
    >
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
      </svg>
      JSON
    </button>
  </div>
  <ul class="divide-y">
    {% if not students %}
        <p class="text-gray-600 italic">No hay estudiantes en esta sala.</p>
    {% endif %}
    {% for student in students %}
    <li x-data="{ open: false, showManualOnly: false }" x-init="const stored = __lsGet('student_{{ student.id }}'); open = stored === 'true'; showManualOnly = __lsGet('student_manual_only_{{ student.id }}') === 'true'" class="py-2">
      <button 
        @click="open = !open; __lsSet('student_{{ student.id }}', open ? 'true' : 'false')" 
        class="w-full flex justify-between items-center text-left px-2 py-2 hover:bg-gray-50 rounded transition"
      >
        <span class="font-medium text-gray-800">
          ðŸ‘¤ {{ student.full_name }} 
          <span class="text-gray-500 text-sm">({{ student.matrix_id }})</span>
        </span>
        <svg 
          :class="{'rotate-180': open}" 
          class="w-4 h-4 transform transition-transform duration-300"
          xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
        >
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                d="M19 9l-7 7-7-7" />
        </svg>
      </button>

      <div 
        x-show="open"
        x-transition
        class="ml-4 mt-2 bg-gray-50 rounded-lg border p-3"
      >
        <h4 class="font-semibold mb-2 text-gray-700">Reacciones:</h4>
        {% if student.reactions %}
          <table class="w-full text-sm text-gray-700">
            <thead>
              <tr class="text-left border-b">
                <th class="py-1 px-2">Emoji</th>
                <th class="py-1 px-2">Conteo</th>
                <th class="py-1 px-2">Ãšltima actualizaciÃ³n</th>
              </tr>
            </thead>
            <tbody>
              {% for reaction in student.reactions %}
              <tr class="hover:bg-gray-100">
                <td class="py-1 px-2">{{ reaction.emoji }}</td>
                <td class="py-1 px-2">{{ reaction.total_count }}</td>
                <td class="py-1 px-2">{{ reaction.latest_update|date:"Y-m-d H:i" }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p class="text-gray-500 italic">Sin reacciones registradas.</p>
        {% endif %}
        
        <h4 class="font-semibold mb-2 text-gray-700 mt-4">Respuestas:</h4>
        {% if student.responses %}
          
          {# Analytics box with both score distribution and participation #}
          {% with sd=student.score_distribution sd_manual=student.score_distribution_manual p=student.participation %}
          {% if sd %}
            <div class="mt-4 p-3 bg-gray-50 rounded-md border border-gray-200">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                
                {# Score distribution chart #}
                {% if sd %}
                <div>
                  <h4 class="text-sm font-semibold text-gray-700 mb-2">Puntuaciones</h4>
                  <div class="flex items-start gap-3">
                    <div class="flex-shrink-0">
                      {% if sd.total > 0 %}
                        <svg width="80" height="80" viewBox="0 0 36 36" x-show="!showManualOnly">
                          <circle cx="18" cy="18" r="15.915" fill="transparent" stroke="#D1D5DB" stroke-width="3.5" 
                                  stroke-dasharray="{{ sd.pct_no_score }} 100" 
                                  stroke-dashoffset="{{ sd.offset_no_score }}" 
                                  transform="rotate(-90 18 18)"></circle>
                          <circle cx="18" cy="18" r="15.915" fill="transparent" stroke="#93C5FD" stroke-width="3.5" 
                                  stroke-dasharray="{{ sd.pct_100 }} 100" 
                                  stroke-dashoffset="{{ sd.offset_100 }}" 
                                  transform="rotate(-90 18 18)"></circle>
                          <circle cx="18" cy="18" r="15.915" fill="transparent" stroke="#6EE7B7" stroke-width="3.5" 
                                  stroke-dasharray="{{ sd.pct_75_99 }} 100" 
                                  stroke-dashoffset="{{ sd.offset_75_99 }}" 
                                  transform="rotate(-90 18 18)"></circle>
                          <circle cx="18" cy="18" r="15.915" fill="transparent" stroke="#FCD34D" stroke-width="3.5" 
                                  stroke-dasharray="{{ sd.pct_50_74 }} 100" 
                                  stroke-dashoffset="{{ sd.offset_50_74 }}" 
                                  transform="rotate(-90 18 18)"></circle>
                          <circle cx="18" cy="18" r="15.915" fill="transparent" stroke="#FCA5A5" stroke-width="3.5" 
                                  stroke-dasharray="{{ sd.pct_0_49 }} 100" 
                                  stroke-dashoffset="0" 
                                  transform="rotate(-90 18 18)"></circle>
                        </svg>
                        <svg width="80" height="80" viewBox="0 0 36 36" x-show="showManualOnly" x-cloak>
                          <circle cx="18" cy="18" r="15.915" fill="transparent" stroke="#D1D5DB" stroke-width="3.5" 
                                  stroke-dasharray="{{ sd_manual.pct_no_score }} 100" 
                                  stroke-dashoffset="{{ sd_manual.offset_no_score }}" 
                                  transform="rotate(-90 18 18)"></circle>
                          <circle cx="18" cy="18" r="15.915" fill="transparent" stroke="#93C5FD" stroke-width="3.5" 
                                  stroke-dasharray="{{ sd_manual.pct_100 }} 100" 
                                  stroke-dashoffset="{{ sd_manual.offset_100 }}" 
                                  transform="rotate(-90 18 18)"></circle>
                          <circle cx="18" cy="18" r="15.915" fill="transparent" stroke="#6EE7B7" stroke-width="3.5" 
                                  stroke-dasharray="{{ sd_manual.pct_75_99 }} 100" 
                                  stroke-dashoffset="{{ sd_manual.offset_75_99 }}" 
                                  transform="rotate(-90 18 18)"></circle>
                          <circle cx="18" cy="18" r="15.915" fill="transparent" stroke="#FCD34D" stroke-width="3.5" 
                                  stroke-dasharray="{{ sd_manual.pct_50_74 }} 100" 
                                  stroke-dashoffset="{{ sd_manual.offset_50_74 }}" 
                                  transform="rotate(-90 18 18)"></circle>
                          <circle cx="18" cy="18" r="15.915" fill="transparent" stroke="#FCA5A5" stroke-width="3.5" 
                                  stroke-dasharray="{{ sd_manual.pct_0_49 }} 100" 
                                  stroke-dashoffset="0" 
                                  transform="rotate(-90 18 18)"></circle>
                        </svg>
                      {% else %}
                        <svg width="80" height="80" viewBox="0 0 36 36">
                          <circle cx="18" cy="18" r="15.915" fill="transparent" stroke="#D1D5DB" stroke-width="3.5" 
                                  stroke-dasharray="100 100" 
                                  stroke-dashoffset="0" 
                                  transform="rotate(-90 18 18)"></circle>
                        </svg>
                      {% endif %}
                    </div>
                    <div class="text-xs text-gray-600 leading-tight">
                      <div x-show="!showManualOnly">
                        <div class="flex items-center gap-1"><span class="inline-block w-2 h-2 bg-red-300 rounded-full"></span><span>0-49: {{ sd.bracket_0_49 }}</span></div>
                        <div class="flex items-center gap-1"><span class="inline-block w-2 h-2 bg-yellow-300 rounded-full"></span><span>50-74: {{ sd.bracket_50_74 }}</span></div>
                        <div class="flex items-center gap-1"><span class="inline-block w-2 h-2 bg-green-300 rounded-full"></span><span>75-99: {{ sd.bracket_75_99 }}</span></div>
                        <div class="flex items-center gap-1"><span class="inline-block w-2 h-2 bg-blue-300 rounded-full"></span><span>100: {{ sd.bracket_100 }}</span></div>
                        <div class="flex items-center gap-1"><span class="inline-block w-2 h-2 bg-gray-300 rounded-full"></span><span>Sin nota: {{ sd.no_score }}</span></div>
                        {% if sd.average is not None %}
                        <div class="mt-1 pt-1 border-t border-gray-300 font-semibold">Media: {{ sd.average }}</div>
                        {% endif %}
                      </div>
                      <div x-show="showManualOnly" x-cloak>
                        <div class="flex items-center gap-1"><span class="inline-block w-2 h-2 bg-red-300 rounded-full"></span><span>0-49: {{ sd_manual.bracket_0_49 }}</span></div>
                        <div class="flex items-center gap-1"><span class="inline-block w-2 h-2 bg-yellow-300 rounded-full"></span><span>50-74: {{ sd_manual.bracket_50_74 }}</span></div>
                        <div class="flex items-center gap-1"><span class="inline-block w-2 h-2 bg-green-300 rounded-full"></span><span>75-99: {{ sd_manual.bracket_75_99 }}</span></div>
                        <div class="flex items-center gap-1"><span class="inline-block w-2 h-2 bg-blue-300 rounded-full"></span><span>100: {{ sd_manual.bracket_100 }}</span></div>
                        <div class="flex items-center gap-1"><span class="inline-block w-2 h-2 bg-gray-300 rounded-full"></span><span>Sin nota: {{ sd_manual.no_score }}</span></div>
                        {% if sd_manual.average is not None %}
                        <div class="mt-1 pt-1 border-t border-gray-300 font-semibold">Media: {{ sd_manual.average }}</div>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                  <button type="button" @click.stop="showManualOnly = !showManualOnly; __lsSet('student_manual_only_{{ student.id }}', showManualOnly ? 'true' : 'false')" 
                          class="mt-2 px-2 py-0.5 text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 rounded transition">
                    <span x-show="!showManualOnly">Solo manuales</span>
                    <span x-show="showManualOnly" x-cloak>Todas</span>
                  </button>
                </div>
                {% endif %}
                
                {# Participation chart #}
                {% if p and p.total > 0 %}
                <div>
                  <h4 class="text-sm font-semibold text-gray-700 mb-2">ParticipaciÃ³n</h4>
                  <div class="flex items-start gap-3">
                    <div class="flex-shrink-0">
                      <svg width="80" height="80" viewBox="0 0 36 36">
                        <circle cx="18" cy="18" r="15.915" fill="transparent" stroke="#D1D5DB" stroke-width="3.5" 
                                stroke-dasharray="{{ p.pct_not_answered }} 100" 
                                stroke-dashoffset="{{ p.offset_not_answered }}" 
                                transform="rotate(-90 18 18)"></circle>
                        <circle cx="18" cy="18" r="15.915" fill="transparent" stroke="#6EE7B7" stroke-width="3.5" 
                                stroke-dasharray="{{ p.pct_answered }} 100" 
                                stroke-dashoffset="0" 
                                transform="rotate(-90 18 18)"></circle>
                      </svg>
                    </div>
                    <div class="text-xs text-gray-600 leading-tight">
                      <div class="flex items-center gap-1"><span class="inline-block w-2 h-2 bg-green-300 rounded-full"></span><span>Respondidas: {{ p.answered }}</span></div>
                      <div class="flex items-center gap-1"><span class="inline-block w-2 h-2 bg-gray-300 rounded-full"></span><span>Sin responder: {{ p.not_answered }}</span></div>
                      <div class="mt-1 pt-1 border-t border-gray-300 font-semibold">Total: {{ p.total }} ({{ p.pct_answered|floatformat:0 }}%)</div>
                    </div>
                  </div>
                </div>
                {% endif %}
                
              </div>
            </div>
          {% endif %}
          {% endwith %}
          
          <ul class="divide-y text-sm text-gray-700">
            {% for r in student.responses %}
              {% include 'dashboard/partials/response_item.html' with r=r students=students show_student_name=False is_general_room=True %}
            {% endfor %}
          </ul>
        {% else %}
          <p class="text-gray-500 italic mt-2">AÃºn no hay respuestas de este estudiante.</p>
        {% endif %}
      </div>
    </li>
    {% endfor %}
  </ul>
</div>
