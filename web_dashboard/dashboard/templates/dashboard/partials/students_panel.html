{% comment %} Students panel: list of students and their reactions {% endcomment %}
<div class="bg-white shadow rounded-lg p-4">
  <h3 class="text-lg font-semibold mb-4">Estudiantes</h3>
  <ul class="divide-y">
    {% if not students %}
        <p class="text-gray-600 italic">No hay estudiantes en esta sala.</p>
    {% endif %}
    {% for student in students %}
    <li x-data="{ open: false }" class="py-2">
      <button 
        @click="open = !open" 
        class="w-full flex justify-between items-center text-left px-2 py-2 hover:bg-gray-50 rounded transition"
      >
        <span class="font-medium text-gray-800">
          ðŸ‘¤ {{ student.full_name }} 
          <span class="text-gray-500 text-sm">({{ student.matrix_id }})</span>
        </span>
        <svg 
          :class="{'rotate-180': open}" 
          class="w-4 h-4 transform transition-transform duration-300"
          xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
        >
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                d="M19 9l-7 7-7-7" />
        </svg>
      </button>

      <div 
        x-show="open"
        x-transition
        class="ml-4 mt-2 bg-gray-50 rounded-lg border p-3"
      >
        <h4 class="font-semibold mb-2 text-gray-700">Reacciones dadas:</h4>
        {% if student.reactions %}
          <table class="w-full text-sm text-gray-700">
            <thead>
              <tr class="text-left border-b">
                <th class="py-1 px-2">Emoji</th>
                <th class="py-1 px-2">Conteo</th>
                <th class="py-1 px-2">Ãšltima actualizaciÃ³n</th>
              </tr>
            </thead>
            <tbody>
              {% for reaction in student.reactions %}
              <tr class="hover:bg-gray-100">
                <td class="py-1 px-2">{{ reaction.emoji }}</td>
                <td class="py-1 px-2">{{ reaction.total_count }}</td>
                <td class="py-1 px-2">{{ reaction.latest_update|date:"Y-m-d H:i" }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p class="text-gray-500 italic">Sin reacciones registradas.</p>
        {% endif %}
        
        <h4 class="font-semibold mb-2 text-gray-700 mt-4">Respuestas dadas:</h4>
        {% if student.responses %}
          <ul class="divide-y text-sm text-gray-700">
            {% for r in student.responses %}
              <li class="py-2">
                <div class="flex items-start gap-3">
                  <div class="w-20 flex-shrink-0">
                    {% if r.score is not None %}
                      {% if r.score == 100 %}
                        <div class="text-center text-xs font-semibold px-2 py-1 rounded bg-blue-100 text-blue-800">{{ r.score }}</div>
                      {% elif r.score >= 75 %}
                        <div class="text-center text-xs font-semibold px-2 py-1 rounded bg-green-100 text-green-800">{{ r.score }}</div>
                      {% elif r.score >= 50 %}
                        <div class="text-center text-xs font-semibold px-2 py-1 rounded bg-yellow-100 text-yellow-800">{{ r.score }}</div>
                      {% else %}
                        <div class="text-center text-xs font-semibold px-2 py-1 rounded bg-red-100 text-red-800">{{ r.score }}</div>
                      {% endif %}
                    {% else %}
                      <div class="text-center text-xs font-medium px-2 py-1 rounded bg-gray-100 text-gray-600">Sin nota</div>
                    {% endif %}
                  </div>

                  <div class="flex-1">
                    <div class="flex justify-between items-start">
                      <div>
                        <div class="font-medium">{{ r.question_title }}</div>
                        <div class="text-xs text-gray-500">{{ r.submitted_at|date:"Y-m-d H:i" }}</div>
                      </div>
                    </div>

                    <div class="mt-1 text-gray-700">
                      {% if r.answer_text %}
                        <div class="mb-1">{{ r.answer_text }}</div>
                      {% endif %}
                      {% if r.option_id %}
                        <div class="text-xs text-gray-600">OpciÃ³n seleccionada: <strong>{{ r.option_key }}</strong></div>
                      {% endif %}
                      {% if r.selected_options %}
                        <div class="text-xs text-gray-600 mt-1">Opciones seleccionadas:
                          {% for so in r.selected_options %}
                            <div class="ml-2">- {{ so.option_key }} â€” {{ so.text }}</div>
                          {% endfor %}
                        </div>
                      {% endif %}

                      {% comment %} Expected answers: either explicit expected text (short_answer/numeric) or correct choices for multiple choice {% endcomment %}
                      {% if r.expected_text %}
                        <div class="text-xs text-gray-500 mt-1">Respuesta esperada: <strong>{{ r.expected_text }}</strong></div>
                      {% elif r.expected_options %}
                        <div class="text-xs text-gray-500 mt-1">Opciones correctas:
                          {% for o in r.expected_options %}
                            <div class="ml-2">- {{ o.option_key }} â€” {{ o.text }}</div>
                          {% endfor %}
                        </div>
                      {% endif %}
                    </div>
                  </div>

                  <div class="w-48 flex-shrink-0 text-right">
                    <div class="text-xs text-gray-500">
                      {% if r.grader %}
                        {% with gname=None %}{% for s2 in students %}{% if s2.moodle_id == r.grader.moodle_id %}{% with gname=s2.full_name %}{% endwith %}{% endif %}{% endfor %}
                          {% if gname %}
                            Corregido por: {{ gname }}
                          {% else %}
                            Corregido por: {{ r.grader.matrix_id }}
                          {% endif %}
                        {% endwith %}
                      {% else %}
                        Corregido por: AutomÃ¡tico
                      {% endif %}
                    </div>
                    {% if r.feedback %}
                      <div class="mt-2 text-sm text-gray-700 bg-gray-50 p-2 rounded">Feedback: {{ r.feedback }}</div>
                    {% endif %}
                    <div class="mt-3">
                      <button type="button" onclick="event.stopPropagation();" class="px-2 py-1 bg-indigo-500 text-white rounded text-sm open-grade-modal" data-response-id="{{ r.id }}" data-score="{{ r.score|default_if_none:'' }}" data-feedback="{{ r.feedback|default_if_none:''|escapejs }}">Corregir</button>
                    </div>
                  </div>
                </div>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="text-gray-500 italic mt-2">AÃºn no hay respuestas de este estudiante.</p>
        {% endif %}
      </div>
    </li>
    {% endfor %}
  </ul>
</div>
