{% comment %} Questions panel: list of questions, controls and per-question UI {% endcomment %}
<div x-data="{open:false}" x-init="open = __lsGet('questions_panel_open') === 'true'" class="bg-white shadow rounded-lg mb-6">
  <div role="button" tabindex="0" class="flex justify-between items-center p-4 cursor-pointer" 
      @click="if(!$event.target.closest('.no-toggle')){ open = !open; __lsSet('questions_panel_open', open ? 'true' : 'false') }"
      @keydown.enter.prevent="if(!$event.target.closest('.no-toggle')){ open = !open; __lsSet('questions_panel_open', open ? 'true' : 'false') }"
      @keydown.space.prevent="if(!$event.target.closest('.no-toggle')){ open = !open; __lsSet('questions_panel_open', open ? 'true' : 'false') }">
    <h3 class="text-lg font-semibold mb-0">Preguntas</h3>
    <div class="flex items-center gap-3">
      <div class="text-sm text-gray-600">{{ questions_list|length }} preguntas</div>
      <button type="button" @click.stop="$store.modal.createQuestionModal = true" class="no-toggle px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 transition" {% if selected_room.teacher_id != teacher.id %}style="display:none"{% endif %}>Crear</button>
      <button 
        type="button"
        @click.stop="downloadQuestionsJSON()" 
        class="no-toggle px-3 py-1.5 bg-blue-500 hover:bg-blue-600 text-white text-sm rounded transition flex items-center gap-1"
        title="Descargar datos de preguntas como JSON"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
        </svg>
        JSON
      </button>
      <button type="button" aria-label="Alternar preguntas" class="p-1" @click.stop="open = !open; __lsSet('questions_panel_open', open ? 'true' : 'false')">
        <svg :class="open ? 'transform rotate-180' : ''" class="w-5 h-5 text-gray-500 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
      </button>
    </div>
  </div>

  <div x-show="open" x-transition class="p-4" id="questions_panel">

    {% if not questions_list %}
      <p class="text-gray-600 italic">No hay preguntas para esta sala.</p>
    {% endif %}

    <ul class="divide-y">
    {% for item in questions_list %}
      {% with q=item.question opts=item.options active_now=item.is_currently_active within_window=item.within_window before_start=item.before_start after_end=item.after_end %}
        {% include 'dashboard/partials/question_item.html' %}
      {% endwith %}
    {% endfor %}
    </ul>
  </div>
</div>

<script>
  (function(){
    function initQuestionsPanel(){
      try{
        const panel = document.querySelector('#questions_panel');
        console.debug('[questions_panel] init - panel?', !!panel);
        if (!panel) return;

        function applyRevealForQuestion(qEl, show){
          const correctInd = qEl.querySelectorAll('.correct-indicator');
          const expectedEls = qEl.querySelectorAll('.expected-answer');
          const respNeutral = qEl.querySelectorAll('.response-neutral');
          const respCorrect = qEl.querySelectorAll('.response-correct');
          const respIncorrect = qEl.querySelectorAll('.response-incorrect');
          correctInd.forEach(el => el.style.display = show ? '' : 'none');
          expectedEls.forEach(el => el.style.display = show ? 'block' : 'none');
          respNeutral.forEach(el => el.style.display = show ? 'none' : '');
          respCorrect.forEach(el => el.style.display = show ? '' : 'none');
          respIncorrect.forEach(el => el.style.display = show ? '' : 'none');
        }

        const buttons = panel.querySelectorAll('.toggle-reveal-btn');
        console.debug('[questions_panel] found buttons:', buttons.length);
        buttons.forEach(btn => {
          const qid = btn.getAttribute('data-qid');
          const li = panel.querySelector(`li[data-question-id="${qid}"]`);
          if (!li) {
            console.debug('[questions_panel] no li for qid', qid);
            return;
          }
          const storageKey = `reveal_answers_q_${qid}`;
          let initial = false;
          initial = (__lsGet(storageKey) === 'true');
          applyRevealForQuestion(li, initial);
          btn.textContent = initial ? 'Ocultar respuesta' : 'Mostrar respuesta';

          btn.addEventListener('click', function(e){
            try{
              e.stopPropagation();
              const cur = (__lsGet(storageKey) === 'true');
              const next = !cur;
              __lsSet(storageKey, next ? 'true' : 'false');
              applyRevealForQuestion(li, next);
              btn.textContent = next ? 'Ocultar respuesta' : 'Mostrar respuesta';
            }catch(err){ console.error('[questions_panel] click handler error', err); }
          });
        });
      }catch(err){ console.error('[questions_panel] init error', err); }
    }

    if (document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', initQuestionsPanel);
    } else {
      initQuestionsPanel();
    }
  })();
</script>
